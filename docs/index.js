function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function changeVolumebar(){const e=document.getElementById("volume"),t=parseInt(e.value);e.dataset.value=t,player.changeVolume(t)}function typeEvent(e){e.keyCode===13&&tts()}function initMoras(){fetch("mora.lst").then(e=>e.text()).then(e=>{e.trimEnd().split(`
`).forEach(e=>{moraSet.add(e)})})}function getNotes(e,t){const o=parseInt(document.getElementById("pitch").value),i=parseInt(document.getElementById("volume").value),c=2,n=[];let a=o,r=i,s=null;for(;t.length>0;){let l=!1;for(let d=c;0<d;d--){const u=t.slice(0,d);if(e.has(u)){const e={instrument:u,duration:"4n",pitch:a,velocity:r,wait:s};n.push(structuredClone(e)),a=o,r=i,s=null,t=t.substring(u.length),l=!0;break}}if(!l){switch(t[0]){case" ":s="16n";break;case"　":s="8n";break;case"っ":s="4n";break;case"…":case"･･･":case"、":case"､":case"，":case",":s="2n";break;case"。":case"｡":case"．":case".":s="1n";break;case"↑":case"↗":case"⤴":case"⇑":case"⇡":n.at(-1).pitch+=1;break;case"⬆":n.at(-1).pitch+=4;break;case"↓":case"↘":case"⤵":case"⇓":case"⇣":n.at(-1).pitch-=1;break;case"⬇":n.at(-1).pitch-=4;break;case"!":n.at(-1).velocity+=8;break;case"‼":case"!!":n.at(-1).velocity+=16;break;case"！":n.at(-1).velocity+=32;break;case"❗":case"❕":n.at(-1).velocity+=64;break;case"?":{const e=structuredClone(n.at(-1));e.duration="32n",e.pitch+=1,n.push(e);break}case"??":case"?!":case"!?":case"？":case"❓":case"❔":{const e=structuredClone(n.at(-1));e.duration="16n",e.pitch+=1,n.push(e);break}case"ー":n.at(-1).duration="2n";break}t=t.substring(1)}}return n}function pitchToNoteName(e){const t=Math.floor(e/12)-1,n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=n[e%12];return`${s}${t}`}function kanaToHira(e){return e.replace(/[\u30a1-\u30f6]/g,e=>{const t=e.charCodeAt(0)-96;return String.fromCharCode(t)})}function tts(){const n=parseInt(document.getElementById("rate").value);Tone.Transport.bpm.value=n;const s=document.getElementById("searchText").value,o=kanaToHira(s),e=getNotes(moraSet,o),t=new Map,i=new Set(e.map(e=>e.instrument));i.forEach(e=>{const n=new Tone.Sampler({urls:{C4:`${e}.opus`},baseUrl:"voices/波音リツ/"}).toDestination();t.set(e,n)}),Tone.loaded().then(()=>{let n=Tone.now();e.forEach(e=>{e.wait&&(n+=Tone.Time(e.wait).toSeconds());const s=t.get(e.instrument);s.triggerAttackRelease(pitchToNoteName(e.pitch),e.duration,n,e.velocity),n+=Tone.Time(e.duration).toSeconds()})})}function resetPitch(){document.getElementById("pitch").value=60}function resetRate(){document.getElementById("rate").value=480}function resetVolume(){document.getElementById("volume").value=500}const moraSet=new Set;let player;loadConfig(),initMoras(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("search").onclick=tts,document.getElementById("volume").onchange=changeVolumebar,document.addEventListener("keydown",typeEvent),document.getElementById("resetPitch").onclick=resetPitch,document.getElementById("resetRate").onclick=resetRate,document.getElementById("resetVolume").onclick=resetVolume