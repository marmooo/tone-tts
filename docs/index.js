function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function changeVolumebar(){const a=document.getElementById("volume"),b=parseInt(a.value);a.dataset.value=b,player.changeVolume(b)}function typeEvent(a){a.keyCode===13&&tts()}function initMoras(){fetch("mora.lst").then(a=>a.text()).then(a=>{a.trimEnd().split("\n").forEach(a=>{moraSet.add(a)})})}function getNotes(i,b){const g=parseInt(document.getElementById("pitch").value),e=parseInt(document.getElementById("volume").value),h=2,a=[];let d=g,f=e,c=null;while(b.length>0){let j=!1;for(let k=h;0<k;k--){const l=b.slice(0,k);if(i.has(l)){const h={instrument:l,duration:"4n",pitch:d,velocity:f,wait:c};a.push(structuredClone(h)),d=g,f=e,c=null,b=b.substring(l.length),j=!0;break}}if(!j){switch(b[0]){case" ":c="16n";break;case"　":c="8n";break;case"っ":c="4n";break;case"…":case"･･･":case"、":case"､":case"，":case",":c="2n";break;case"。":case"｡":case"．":case".":c="1n";break;case"↑":case"↗":case"⤴":case"⇑":case"⇡":a.at(-1).pitch+=1;break;case"⬆":a.at(-1).pitch+=4;break;case"↓":case"↘":case"⤵":case"⇓":case"⇣":a.at(-1).pitch-=1;break;case"⬇":a.at(-1).pitch-=4;break;case"!":a.at(-1).velocity+=8;break;case"‼":case"!!":a.at(-1).velocity+=16;break;case"！":a.at(-1).velocity+=32;break;case"❗":case"❕":a.at(-1).velocity+=64;break;case"?":{const b=structuredClone(a.at(-1));b.duration="32n",b.pitch+=1,a.push(b);break}case"??":case"?!":case"!?":case"？":case"❓":case"❔":{const b=structuredClone(a.at(-1));b.duration="16n",b.pitch+=1,a.push(b);break}case"ー":a.at(-1).duration="2n";break}b=b.substring(1)}}return a}function pitchToNoteName(a){const b=Math.floor(a/12)-1,c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],d=c[a%12];return`${d}${b}`}function kanaToHira(a){return a.replace(/[\u30a1-\u30f6]/g,a=>{const b=a.charCodeAt(0)-96;return String.fromCharCode(b)})}function tts(){const c=parseInt(document.getElementById("rate").value);Tone.Transport.bpm.value=c;const d=document.getElementById("searchText").value,e=kanaToHira(d),a=getNotes(moraSet,e),b=new Map,f=new Set(a.map(a=>a.instrument));f.forEach(a=>{const c=new Tone.Sampler({urls:{C4:`${a}.opus`},baseUrl:"voices/波音リツ/"}).toDestination();b.set(a,c)}),Tone.loaded().then(()=>{let c=Tone.now();a.forEach(a=>{a.wait&&(c+=Tone.Time(a.wait).toSeconds());const d=b.get(a.instrument);d.triggerAttackRelease(pitchToNoteName(a.pitch),a.duration,c,a.velocity),c+=Tone.Time(a.duration).toSeconds()})})}function resetPitch(){document.getElementById("pitch").value=60}function resetRate(){document.getElementById("rate").value=480}function resetVolume(){document.getElementById("volume").value=500}const moraSet=new Set;let player;loadConfig(),initMoras(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("search").onclick=tts,document.getElementById("volume").onchange=changeVolumebar,document.addEventListener("keydown",typeEvent),document.getElementById("resetPitch").onclick=resetPitch,document.getElementById("resetRate").onclick=resetRate,document.getElementById("resetVolume").onclick=resetVolume